{"id":"bud-0il","title":"Conversation context loss between messages","description":"Sometimes Bud asks a question, user answers, but next message doesn't understand what user was replying to. Likely issue with prompt injection of past conversation/actions. Journal actions should include back-and-forth conversation but may not be capturing it properly.","design":"## Root Cause Analysis (2026-01-02)\n\n**Primary Issue: Message Truncation**\n\nJournal entries only store first 100 characters of messages:\n\n```typescript\n// src/agent.ts:93-99 (triggers)\nawait appendJournal({\n  type: \"trigger\",\n  preview: userMessage.slice(0, 100),  // ← Truncated!\n});\n\n// src/agent.ts:150-157 (responses)\nawait appendJournal({\n  type: \"message_sent\",\n  preview: result.response.slice(0, 100),  // ← Truncated!\n});\n```\n\n**Reproduction Case:**\n- Bud sends a message with a question after character 100\n- User replies \"yes\"\n- Next invocation loads journal with only first 100 chars of Bud's message\n- Bud has no idea what user said \"yes\" to\n\n**Secondary Issue: Tool Flood**\n\nTool-use entries can dominate the 40-entry context window. After a tool-heavy session (e.g., 78 tool calls), the window may contain:\n- 39 tool_use entries\n- 1 message_sent\n- 0 triggers\n\nThis pushes out conversation context entirely.\n\n## Fix\n\n**For truncation:**\n- Change `preview` to `content` in journal entries\n- Remove `.slice(0, 100)` truncation\n- Store full message text\n\n**For tool flood (separate issue):**\n- Filter tool_use entries when loading context, OR\n- Ensure minimum N conversation entries are always included\n\n## Files to Change\n\n- `src/agent.ts:93-99` - Remove truncation from trigger logging\n- `src/agent.ts:150-157` - Remove truncation from message_sent logging\n- `src/memory/journal.ts:64-77` - Update formatJournalForPrompt if field name changes","acceptance_criteria":"- [ ] Triggers logged with full message content (not 100-char preview)\n- [ ] Responses logged with full message content\n- [ ] formatJournalForPrompt handles new field name\n- [ ] Test: Send message \u003e100 chars with question at end, reply works","status":"open","priority":1,"issue_type":"bug","created_at":"2026-01-01T15:28:25.870249356Z","created_by":"Bud","updated_at":"2026-01-02T01:06:59.038914+01:00","labels":["context","conversation-flow","prompt-injection"]}
{"id":"bud-0rf","title":"Investigate schema validation error in beads-mcp","description":"Schema validation errors are occurring, possibly due to mismatch between beads-mcp and the bd CLI tool. Need to compare schemas and identify discrepancies.","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-01T15:19:24.4114874Z","created_by":"Bud","updated_at":"2026-01-01T15:19:24.4114874Z","labels":["beads","mcp","schema"]}
{"id":"bud-55m","title":"Optimize beads performance - cold start and multi-repo checks","description":"Two performance issues: 1) Cold start takes ~8 seconds on first call, 2) Tool seems to check multiple repos when it should only check one. Second issue may be a prompting problem.","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-01T15:19:24.491318832Z","created_by":"Bud","updated_at":"2026-01-01T15:19:24.491318832Z","labels":["beads","mcp","performance"]}
{"id":"bud-6r3","title":"Investigate why Bud is not autonomous on perch ticks","description":"Bud is meant to be semi-autonomous but currently doesn't do work outside of explicit requests. On perch ticks that trigger wake-up, Bud should identify work and tackle it independently. Need to investigate root cause: missing prompt instructions? lack of focus in memory? other issues?","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T15:19:24.551871838Z","created_by":"Bud","updated_at":"2026-01-01T15:29:54.396618758Z","closed_at":"2026-01-01T15:29:54.396618758Z","close_reason":"Closed via update","labels":["autonomy","core-behavior","scheduler"]}
{"id":"bud-h6k","title":"Implement focus review task for goal generation","description":"Create a scheduled task that runs daily to review focus areas and generate/adjust goals. This is the tactical layer that connects strategic focus to operational goal execution.","design":"## Design: Focus Review Task\n\n**Purpose**: Bridge the gap between strategic focus areas and operational goals by autonomously generating goal proposals.\n\n## Architecture\n\n**Layer**: Tactical (between Strategic focus and Operational execution)\n\n**Trigger**: Scheduled task, runs daily (e.g., 9am Berlin time)\n\n**Inputs**:\n- `focus` memory block (strategic direction)\n- `goals` memory block (existing goals)\n- Beads ready tasks (if focus is repo-related)\n- Calendar events (if focus is time-bound)\n- GitHub PRs/issues (if focus is code-related)\n\n**Outputs**:\n- Updated `goals` memory block\n- Optionally: message to Dan for approval on uncertain proposals\n\n## Process Flow\n\n### 1. Load Context\n```typescript\nconst focus = await getMemoryBlock('focus')\nconst currentGoals = await getMemoryBlock('goals')\n```\n\n### 2. Analyze Focus Areas\nFor each focus area:\n- Identify the domain (repo work, research, communication, etc.)\n- Determine what tools/data sources are relevant\n- Query those sources for actionable items\n\nExample for \"Working on Bud repository\":\n- Query beads for open, unblocked tasks assigned to Bud\n- Check if existing goals cover these tasks\n- Identify gaps\n\n### 3. Evaluate Current Goals\n- Are existing goals still relevant to focus?\n- Have goals become stale or blocked?\n- Should any goals be closed or deferred?\n\n### 4. Generate Proposals\n**High Confidence (auto-apply)**:\n- Focus area has no corresponding goal → create one\n- Beads task with priority 1 exists → create goal with deadline\n- Goal completed but focus remains → create next-step goal\n\n**Low Confidence (ask for approval)**:\n- Multiple competing approaches\n- Significant time commitment\n- Cross-cutting concerns\n\n### 5. Update or Request Approval\n```typescript\nif (highConfidence) {\n  await updateMemoryBlock('goals', newGoals)\n  log('Updated goals based on focus review')\n} else {\n  await askDan(proposals, reasoning)\n}\n```\n\n## Goal Format\n\nGoals should be:\n- **Specific**: Clear, actionable objective\n- **Measurable**: Can determine when complete\n- **Time-bound**: Has deadline or timeframe\n- **Linked**: References beads ID, calendar event, etc. if applicable\n\nExample:\n```json\n{\n  \"id\": \"goal-1\",\n  \"description\": \"Complete bud-of5 implementation\",\n  \"focus_area\": \"Working on Bud repository\",\n  \"deadline\": \"2026-01-01 EOD\",\n  \"priority\": 1,\n  \"links\": [\"bud-of5\"],\n  \"status\": \"active\"\n}\n```\n\n## Implementation Details\n\n**File**: `src/perch/focus-review.ts`\n\n**Key Functions**:\n- `reviewFocusAndGoals()` - main entry point\n- `analyzeFocusArea(area)` - domain-specific analysis\n- `evaluateGoalRelevance(goal, focus)` - check alignment\n- `generateGoalProposals(focus, currentGoals, context)` - create suggestions\n- `applyHighConfidenceProposals(proposals)` - auto-update goals\n- `requestApprovalForProposals(proposals)` - ask Dan\n\n**Scheduler Integration**:\nAdd to `SCHEDULED_TASKS` in `src/perch/work.ts`:\n```typescript\n{\n  id: 'focus_review',\n  name: 'Review focus areas and generate goals',\n  schedule: { hour: 9, minute: 0 }, // 9am daily\n  handler: reviewFocusAndGoals\n}\n```\n\n## Success Criteria\n\n- Focus review runs daily without errors\n- Goals are generated for active focus areas\n- Stale goals are identified and cleaned up\n- Dan is only pinged for uncertain decisions\n- Scheduler can execute goals autonomously\n- Clear audit trail in memory history","acceptance_criteria":"- [ ] `src/perch/focus-review.ts` created with core logic\n- [ ] Focus review task scheduled in `src/perch/work.ts`\n- [ ] Can read focus and goals memory blocks\n- [ ] Analyzes repo-related focus using beads\n- [ ] Generates high-confidence goal proposals automatically\n- [ ] Requests approval for uncertain proposals\n- [ ] Updates goals memory block on successful review\n- [ ] Logs review activity for debugging\n- [ ] Handles errors gracefully (doesn't crash scheduler)\n- [ ] Manual test: trigger focus review, verify goals updated","status":"closed","priority":2,"issue_type":"feature","assignee":"bud","created_at":"2026-01-01T16:00:34.409223548Z","created_by":"Bud","updated_at":"2026-01-01T16:35:19.579370663Z","closed_at":"2026-01-01T16:26:21.734010523Z","close_reason":"Completed - focus review system implemented and tested","external_ref":"https://github.com/vthunder/bud/pull/3","labels":["autonomy","core-behavior","goals","scheduler"],"dependencies":[{"issue_id":"bud-h6k","depends_on_id":"bud-of5","type":"blocks","created_at":"2026-01-01T16:00:34.434670409Z","created_by":"unknown"}]}
{"id":"bud-of5","title":"Implement autonomous work identification and execution","description":"After investigation, implement the solution to enable Bud to autonomously identify and tackle work on perch ticks. This is the implementation task that follows the investigation.","design":"## Design (Updated 2026-01-01)\n\n**Goal**: Enable Bud to autonomously identify and execute work during perch ticks.\n\n**Core Principle**: Goals drive everything. The scheduler evaluates goals first, then determines what tools/data sources are needed to support those goals.\n\n## Architecture Overview\n\n**Three-Layer System:**\n\n1. **Strategic Layer (Focus Areas)**\n   - Stored in `focus` memory block\n   - Owner-controlled strategic direction\n   - Updated manually by Dan or occasionally by Bud\n   - Examples: \"Working on Bud repository\", \"Preparing quarterly review\"\n\n2. **Tactical Layer (Goals)**\n   - Stored in `goals` memory block\n   - Generated from focus areas by focus review task\n   - Time-bound, actionable objectives\n   - Can be proposed autonomously by Bud based on focus\n\n3. **Operational Layer (Scheduler)**\n   - Executes ready goals via `selectWork()` in perch ticks\n   - Simple: loads goals, evaluates actionability, picks work\n   - Doesn't generate goals, just executes them\n\n## Architecture Changes\n\n### 1. Scheduler (Operational Layer)\n\n**Current Problem**: \n- Scheduler's `selectWork()` has hardcoded priority ladder\n- `check_goals()` only looks at beads-ready tasks (too narrow)\n- Beads is treated as the center of the universe\n\n**New Approach**:\n- Goals are domain-agnostic and flexible\n- Scheduler loads goals from memory and evaluates actionability\n- Goals determine what tools to use (beads, web search, calendar, etc.)\n- Beads is just one data source, relevant for repo-related work\n\n**Updated Priority Ladder:**\n```\nPriority 1: Scheduled tasks (time-bound commitments)\nPriority 2: Actionable goals (from memory, with tool context)\nPriority 3: Maintenance (sync state, health checks)\n```\n\n### 2. Focus Review Task (Tactical Layer)\n\n**New Scheduled Task: `review_focus_and_goals`**\n\n**Purpose**: Generate goals based on current focus areas\n\n**Frequency**: Daily or when focus changes\n\n**Process**:\n1. Read `focus` memory block (strategic direction)\n2. Read `goals` memory block (existing goals)\n3. Evaluate gaps:\n   - Are there active goals for each focus area?\n   - Are existing goals still relevant?\n   - Are there obvious next steps missing?\n4. Propose new goals or adjustments\n5. Ask Dan for approval if uncertain\n6. Update `goals` memory block\n\n**Benefits**:\n- Clean separation: focus → goals → execution\n- Bud can be proactive without cluttering hot path\n- Different cadences for strategy vs. execution\n- Dan maintains control over focus while Bud helps with goal generation\n\n### 3. Implementation Plan\n\n**Step 1: Refactor `check_goals()` in scheduler**\n- Load goals from memory block \"goals\"\n- Evaluate which goals are actionable by:\n  - Deadline proximity (time-based)\n  - Priority level\n  - Blocker status\n  - Dependencies\n- Return the most important actionable goal with relevant context\n\n**Step 2: Goal-aware work selection**\n- If goal is repo-related → query beads for supporting context\n- If goal is research-related → prepare for web search/doc reading\n- If goal is communication-related → check calendar/GitHub notifications\n- If goal is data-related → prepare analysis tools\n\n**Step 3: Create `src/perch/beads.ts` helper**\n- Query ready tasks when goals indicate repo work\n- Filter: status=open, no blockers, assignee=Bud or unassigned\n- Sort by priority, return top task or null\n\n**Step 4: Implement focus review task**\n- Create scheduled task definition\n- Set daily cadence (e.g., 9am)\n- Implement focus analysis logic\n- Add goal proposal workflow\n- Include approval mechanism for uncertain changes\n\n## Benefits\n\n- **Flexible**: Goals can be any domain, not just repo work\n- **Intelligent**: Scheduler evaluates actionability before acting\n- **Tool-agnostic**: Beads/calendar/github are supporting data, not drivers\n- **Maintainable**: Clear separation between goal evaluation and tool selection\n- **Scalable**: Easy to add new goal types and supporting tools\n- **Strategic alignment**: Goals flow from focus areas, ensuring work aligns with direction\n\n## Example Scenarios\n\n**Scenario 1: Repo work goal**\n- Goal: \"Implement autonomous work identification (bud-of5)\"\n- Scheduler evaluates: actionable, high priority, no blockers\n- Determines: repo-related → queries beads for context\n- Returns work item with beads task details\n\n**Scenario 2: Research goal**\n- Goal: \"Research streaming LLM patterns for real-time feedback\"\n- Scheduler evaluates: actionable, medium priority\n- Determines: research-related → prepares web search\n- Returns work item with research context\n\n**Scenario 3: Focus-driven goal generation**\n- Focus: \"Working on Bud repository - self-improvement\"\n- Focus review task runs daily\n- Checks beads for open issues in bud repo\n- Proposes goal: \"Complete bud-of5 implementation by EOD\"\n- Updates goals memory block\n\n**Scenario 4: No actionable goals**\n- Scheduler evaluates all goals\n- All blocked or low priority with no deadline pressure\n- Falls back to Priority 3: maintenance tasks","notes":"## Investigation Findings (2026-01-01)\n\n**Current Autonomous Behavior:**\nThe perch tick system already has autonomous work capability through `selectWork()` in `src/perch/work.ts`:\n\n1. **Priority 1**: Scheduled tasks (from memory block \"schedule\")\n2. **Priority 2**: Active goals (from memory block \"goals\")  \n3. **Priority 3**: Maintenance (e.g., sync state every 24h)\n\n**The Problem:**\nCurrently returns `null` (no work) most of the time because:\n- No scheduled tasks in memory\n- No active goals in memory (just set focus, but not goals)\n- Maintenance only triggers every 24h\n\n**Missing: Beads Integration**\nThe beads MCP tools are available in both `perch.ts` and `agent.ts`, but `selectWork()` never queries beads for ready tasks. This is the key gap.\n\n**Proposed Solution:**\nAdd Priority 1.5 in `selectWork()`: Check beads for ready tasks (no blockers, assigned to Bud or unassigned). If found, return work item to tackle the highest priority ready bead.\n\nThis would enable autonomous work on beads tasks during perch ticks without requiring explicit scheduled tasks or goals.","status":"closed","priority":1,"issue_type":"feature","assignee":"Bud","created_at":"2026-01-01T15:19:29.498004871Z","created_by":"Bud","updated_at":"2026-01-01T16:17:30.70387792Z","closed_at":"2026-01-01T16:17:30.70387792Z","close_reason":"Closed via update","labels":["autonomy","core-behavior","scheduler"],"dependencies":[{"issue_id":"bud-of5","depends_on_id":"bud-6r3","type":"blocks","created_at":"2026-01-01T15:19:29.513184465Z","created_by":"unknown"}]}
{"id":"bud-t7j","title":"Tool invocations in journal missing details","description":"Journal entries for tool_use only capture the tool name (e.g. 'Bash', 'Read') but not the actual parameters or commands. This makes it hard to reconstruct what actions were taken when reviewing the journal for context.","design":"## Problem\n\nCurrent tool logging in `src/execution.ts:113-116`:\n```typescript\nappendJournal({\n  type: \"tool_use\",\n  tool: block.name,  // ← Only the name!\n});\n```\n\nThis produces entries like:\n```json\n{\"ts\":\"...\",\"type\":\"tool_use\",\"tool\":\"Bash\"}\n```\n\nNo visibility into what command was run, what file was read, etc.\n\n## Fix\n\nInclude tool input parameters:\n```typescript\nappendJournal({\n  type: \"tool_use\",\n  tool: block.name,\n  input: summarizeToolInput(block.name, block.input),\n});\n```\n\nWhere `summarizeToolInput` extracts key details:\n- Bash: the command (truncated if very long)\n- Read: the file path\n- Edit: file path + old_string preview\n- Grep: pattern + path\n- etc.\n\n## Considerations\n\n- Don't log sensitive data (env vars, secrets)\n- Truncate very long inputs to avoid journal bloat\n- Balance detail vs. context window usage\n\n## Files to Change\n\n- `src/execution.ts:113-116` - Add input capture to tool_use logging","acceptance_criteria":"- [ ] tool_use journal entries include meaningful input summary\n- [ ] Bash entries show command (truncated if \u003e200 chars)\n- [ ] Read/Edit entries show file path\n- [ ] Grep entries show pattern\n- [ ] No sensitive data leaked in journal","status":"open","priority":3,"issue_type":"bug","created_at":"2026-01-02T00:00:00Z","created_by":"claude","updated_at":"2026-01-02T00:00:00Z","labels":["context","journal","logging"]}
{"id":"bud-xig","title":"Implement autonomous work identification and execution","description":"After investigation, implement the solution to enable Bud to autonomously identify and tackle work on perch ticks. This is the implementation task that follows the investigation.","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-01T15:19:24.612335668Z","created_by":"Bud","updated_at":"2026-01-01T16:19:19.14243334Z","closed_at":"2026-01-01T16:19:19.14243334Z","close_reason":"Duplicate of bud-of5 which has been completed with full design","labels":["autonomy","core-behavior","scheduler"]}
